<!doctype html>
<meta charset="utf-8">
<title>chao.js</title>
<head>
	<style type="text/css">
		body {
			margin: 0;
			background-color: #202020
		}
	</style>
</head>
<body>
	<center>
<script src="chao.js"></script>
<script>

	chao.init(640, 480);
	chao.backgroundColor = "#ffffff";

	chao.loadMusic("nature", "assets/nature.ogg", "assets/nature.mp3", 0.2);
	chao.loadSound("oh", "assets/oh.wav", 1.0);
	chao.loadSound("ugh", "assets/ugh.wav");
	chao.loadSound("plum", "assets/plum.wav");

	chao.loadImage("sticker", "sticker.png");
	chao.loadImage("zbylut", "assets/zbylut.png");
	chao.loadImage("button_sound_on", "assets/sound_on.png");
	chao.loadImage("button_sound_off", "assets/sound_off.png");
	chao.loadImage("button", "assets/button.png");

	function ComponentLudzik(){
		this.name 				= "Ludzik";

		this.create = function(){
			this.image = this.entity.addComponent(new ComponentImage("zbylut", 30, 30));

			this.image.addAnim("idle_n", [4], 0, false);
			this.image.addAnim("idle_s", [0], 0, false);
			this.image.addAnim("idle_w", [8], 0, false);
			this.image.addAnim("idle_nw", [16], 0, false);
			this.image.addAnim("idle_sw", [12], 0, false);

			this.image.addAnim("run_n", [5, 4, 6, 4], 0.2, true);
			this.image.addAnim("run_s", [1, 0, 2, 0], 0.2, true);
			this.image.addAnim("run_w", [9, 8], 0.2, true);
			this.image.addAnim("run_nw", [17, 16, 18, 16], 0.2, true);
			this.image.addAnim("run_sw", [13, 12, 14, 12], 0.2, true);

			this.image.playAnim("idle_s");
		}

		this.update = function(){
			var direction 	= "";
			var animName 	= "idle";

			if(chao.keys[chao.KEY_UP]){
				direction += "n";
			}else if(chao.keys[chao.KEY_DOWN]){
				direction += "s";
			}
			
			if(chao.keys[chao.KEY_LEFT]){
				direction += "w";
			}else if(chao.keys[chao.KEY_RIGHT]){
				direction += "e";
			}

			if(direction.length > 0){
				switch(direction){
					case "n" : 
						animName 			= "run_n";
						this.image.flipX 	= false;
						break;
					case "s" : 
						animName 			= "run_s";
						this.image.flipX 	= false;
						break;
					case "w" : 
						animName 			= "run_w";
						this.image.flipX 	= false;
						break;
					case "e" : 
						animName 			= "run_w";
						this.image.flipX 	= true;
						break;
					case "nw" : 
						animName 			= "run_nw";
						this.image.flipX 	= false;
						break;
					case "ne" : 
						animName 			= "run_nw";
						this.image.flipX 	= true;
						break;
					case "sw" : 
						animName 			= "run_sw";
						this.image.flipX 	= false;
						break;
					case "se" : 
						animName 			= "run_sw";
						this.image.flipX 	= true;
				}
			}

			if(animName === "idle"){
				animName = this.image.getCurrentAnim().key;

				var dashPos = animName.indexOf("_");
				animName = "idle" + animName.substr(dashPos);
			}

			this.image.playAnim(animName, false);

			var currSpeed = chao.getTimeDelta() * 80;
			if(direction.indexOf("n") != -1){
				this.entity.y -= currSpeed;
			}
			if(direction.indexOf("s") != -1){
				this.entity.y += currSpeed;
			}
			if(direction.indexOf("w") != -1){
				this.entity.x -= currSpeed;
			}
			if(direction.indexOf("e") != -1){
				this.entity.x += currSpeed;
			}

		}

	}

	var StateGame = {

		bounceTimer: 0.0,
		texts: [],

		create: function(){

			chao.countFPS = true;

			this.thingie = new Entity("Thingie", 100, 100);
			this.thingie.addComponent(new ComponentImage("sticker"));
			this.thingie.clickable = true;
			// this.add(this.thingie);

			var zbylut = new Entity("Zbylut", 400, 100);
			zbylut.addComponent(new ComponentLudzik());
			zbylut.scaleX = 2;
			zbylut.scaleY = 2;
			zbylut.clickable = true;
			// this.add(zbylut);

			this.buttonMute = (new Entity("Button Mute")).addComponent(new ComponentButton("button_sound_on"));
			this.buttonMute.entity.x = chao.screenWidth - 60;
			this.buttonMute.entity.y = chao.screenHeight - 60;
			this.buttonMute.onRelease = function(button){
				chao.toggleMute();
				if(chao.muted){
					this.setImage("button_sound_off");
				} else {
					this.setImage("button_sound_on");
				}
			};
			this.add(this.buttonMute.entity);

			var buttonSound = (new Entity("Button Sound")).addComponent(new ComponentButton("button"));
			buttonSound.entity.x = chao.screenWidth - 300;
			buttonSound.entity.y = chao.screenHeight - 50;
			buttonSound.setText(chao.font, "Hmmm!", 20);
			buttonSound.onRelease = this.playSound;
			this.add(buttonSound.entity);

			// ComponentText stress test
			// huh, 17fps
			// well, still better than phaser
			// for(var i = 0; i < 100; ++i){
			// 	var someText = new Entity("TextTest", 0, 0);
			// 	var textComponent = someText.addComponent(new ComponentText(chao.font, "Food `10th`14is ````way -->", 25));
			// 	this.add(someText);
			// 	this.texts.push(textComponent);
			// }

			var textTest = (new Entity("TextTest", 300, 300)).addComponent(new ComponentText(chao.font, "Food `10th`14is ````way -->", 25));
			this.add(textTest.entity);
			textTest.align = "center";
			textTest.backgroundColor = "gray";
			textTest.text = "`1albowiem `3zaprawde `6kilka `8kolorkow\noraz niesamowita istnie\nmulti`12linia!";

			// chao.playSound("nature");

		},

		draw: function(){
			chao.drawText(chao.canvas, 
				chao.font, 
				"Bacon impsum dolor\nsit pork chop", 
				0, 0, 
				30, 
				chao.makeColor(255, 255, 255), 
				"left",
				chao.makeColor(0, 0, 0),
				2);
		},

		update: function(){
			this.bounceTimer += chao.getTimeDelta() * 3;
			this.thingie.y = 100 + Math.sin(this.bounceTimer) * 20;

			this.thingie.rotation 	= Math.cos(this.bounceTimer) * 20;
			this.thingie.scaleX 	= (0.8 + (Math.sin(this.bounceTimer) * 0.2));
			this.thingie.scaleY 	= (0.8 + (Math.cos(this.bounceTimer) * 0.2));

			for(var i = 0; i < chao.touches.length; ++i){
				if(chao.touches[i].justPressed){
					// chao.log(chao.touches[i]);
				}
			}
			// for(var i = 0; i < this.texts.length; ++i){
			// 	this.texts[i].text = "" + chao.getRandom(99999) + "x" + chao.getRandom(99999);
			// }

		},

		playSound: function(button){
			chao.playSound("oh");
		},

	};
	
	chao.switchState(StateGame);



</script>
</body>