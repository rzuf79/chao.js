<!doctype html>
<meta charset="utf-8">
<title>chao.js</title>
<head>
	<style type="text/css">
		body {
			margin: 0;
			background-color: #202020
		}

		#debug {
			text-align:left;
			width:640px;
			height:250px;
			border:1px solid #888;
			font: 10px monospace;
			overflow: auto;
			background-color:#f8fcff;
			margin: 10px auto;
			padding:10px;
		}
	</style>
</head>
<body>
	<center>
		<canvas id="canvas_id" width="640" height="480"></canvas>
		<div id="debug"></div>

<script src="chao.js"></script>
<script>

	chao.setupLogTarget("debug");
	chao.init(640, 480, chao.SCALING_MODE_NONE, "canvas_id");
	chao.backgroundColor = "#ffffff";
	chao.pauseOnFadeEnabled	= false;
	chao.muteOnFocusLost = false;

	chao.loadMusic("nature", "assets/nature.ogg", "assets/nature.mp3", 0.2);
	chao.loadSound("oh", "assets/oh.wav", 1.0, false, 6);
	chao.loadSound("ugh", "assets/ugh.wav");
	chao.loadSound("plum", "assets/plum.wav");
	chao.loadSound("jump", "assets/jump.wav");

	chao.loadImage("sticker", "sticker.png");
	chao.loadImage("zbylut", "assets/zbylut.png");
	chao.loadImage("button_sound_on", "assets/sound_on.png");
	chao.loadImage("button_sound_off", "assets/sound_off.png");
	chao.loadImage("button", "assets/button.png");
	chao.loadImage("cloudy", "assets/cloudy.png");

	function ComponentLudzik(){
		this.name 				= "Ludzik";

		this.create = function(){
			this.image = this.entity.addComponent(new ComponentImage("zbylut", 30, 30));

			this.entity.keepClickFocus = true;

			this.image.addAnim("idle_n", [4], 0, false);
			this.image.addAnim("idle_s", [0], 0, false);
			this.image.addAnim("idle_w", [8], 0, false);
			this.image.addAnim("idle_nw", [16], 0, false);
			this.image.addAnim("idle_sw", [12], 0, false);

			this.image.addAnim("run_n", [5, 4, 6, 4], 0.2, true);
			this.image.addAnim("run_s", [1, 0, 2, 0], 0.2, true);
			this.image.addAnim("run_w", [9, 8], 0.2, true);
			this.image.addAnim("run_nw", [17, 16, 18, 16], 0.2, true);
			this.image.addAnim("run_sw", [13, 12, 14, 12], 0.2, true);

			this.image.playAnim("idle_s");
		}

		this.update = function(){
			var direction 	= "";
			var animName 	= "idle";

			if(chao.keys[chao.KEY_UP]){
				direction += "n";
			}else if(chao.keys[chao.KEY_DOWN]){
				direction += "s";
			}
			
			if(chao.keys[chao.KEY_LEFT]){
				direction += "w";
			}else if(chao.keys[chao.KEY_RIGHT]){
				direction += "e";
			}

			if(direction.length > 0){
				switch(direction){
					case "n" : 
						animName 			= "run_n";
						this.image.flipX 	= false;
						break;
					case "s" : 
						animName 			= "run_s";
						this.image.flipX 	= false;
						break;
					case "w" : 
						animName 			= "run_w";
						this.image.flipX 	= false;
						break;
					case "e" : 
						animName 			= "run_w";
						this.image.flipX 	= true;
						break;
					case "nw" : 
						animName 			= "run_nw";
						this.image.flipX 	= false;
						break;
					case "ne" : 
						animName 			= "run_nw";
						this.image.flipX 	= true;
						break;
					case "sw" : 
						animName 			= "run_sw";
						this.image.flipX 	= false;
						break;
					case "se" : 
						animName 			= "run_sw";
						this.image.flipX 	= true;
				}
			}

			if(animName === "idle"){
				animName = this.image.getCurrentAnim().key;

				var dashPos = animName.indexOf("_");
				animName = "idle" + animName.substr(dashPos);
			}

			this.image.playAnim(animName, false);

			var currSpeed = chao.getTimeDelta() * 80;
			if(direction.indexOf("n") != -1){
				this.entity.y -= currSpeed;
			}
			if(direction.indexOf("s") != -1){
				this.entity.y += currSpeed;
			}
			if(direction.indexOf("w") != -1){
				this.entity.x -= currSpeed;
			}
			if(direction.indexOf("e") != -1){
				this.entity.x += currSpeed;
			}
		}
	}

	var StateGame = {

		bounceTimer: 0.0,
		texts: [],

		create: function(){

			chao.countFPS = true;

			this.thingie = new Entity("Thingie", 100, 100);
			this.thingie.addComponent(new ComponentImage("sticker"));
			this.thingie.clickable = true;
			this.add(this.thingie);

			var zbylut = new Entity("Zbylut", 400, 100);
			zbylut.addComponent(new ComponentLudzik());
			zbylut.scaleX = 2;
			zbylut.scaleY = 2;
			zbylut.clickable = true;
			this.add(zbylut);

			this.buttonMute = (new Entity("Button Mute")).addComponent(new ComponentButton("button_sound_on"));
			this.buttonMute.entity.x = chao.screenWidth - 60;
			this.buttonMute.entity.y = chao.screenHeight - 60;
			this.buttonMute.onReleased = function(button){
				chao.toggleMute();
				if(chao.muted){
					this.setImage("button_sound_off");
				} else {
					this.setImage("button_sound_on");
				}
			};
			this.add(this.buttonMute.entity);

			this.buttonSound = (new Entity("Button Sound", chao.screenWidth-300, chao.screenHeight-50)).addComponent(new ComponentButton("button"));
			this.buttonSound.setText(chao.font, "Hmmm!", 20);
			this.buttonSound.onRelease = this.playSound;
			this.add(this.buttonSound.entity);

			this.buttonLog = (new Entity("Button Log", chao.screenWidth-500, chao.screenHeight-50)).addComponent(new ComponentButton("button"));
			this.buttonLog.setText(chao.font, "Log things", 20);
			this.buttonLog.onReleased = function() { chao.logHierarchy(); }
			this.add(this.buttonLog.entity);


			var textTest = (new Entity("TextTest", 300, 300)).addComponent(new ComponentText(chao.font, "Food `10th`14is ````way -->", 25));
			this.add(textTest.entity);
			textTest.align = "center";
			textTest.backgroundColor = "gray";
			textTest.text = "`1albowiem `3zaprawde `6kilka `8kolorkow\noraz niesamowita istnie\nmulti`12linia!";

			chao.playSound("nature");

			// chao.logHierarchy();

		},

		resize: function(){
			this.buttonMute.entity.alignToParent(1.0, 1.0, 1.0, 1.0, -10);
			this.buttonSound.entity.alignToParent(1.0, 1.0, 1.5, 1.0, -20, -10);
			this.buttonLog.entity.alignToParent(1.0, 1.0, 2.5, 1.0, -30, -10);
		},

		draw: function(){
			var text = "Bacon impsum dolor\nsit pork chop";
			// var text = "" + chao.screenScaleX + "x" + chao.screenScaleY;

			chao.drawText(chao.canvas, 
				chao.font, 
				text, 
				0, 0, 
				30, 
				chao.makeColor(255, 255, 255), 
				"left",
				chao.makeColor(0, 0, 0),
				2);
		},

		update: function(){
			this.bounceTimer += chao.getTimeDelta() * 3;
			this.thingie.y = 100 + Math.sin(this.bounceTimer) * 20;

			this.thingie.rotation 	= Math.cos(this.bounceTimer) * 20;
			this.thingie.scaleX 	= (0.8 + (Math.sin(this.bounceTimer) * 0.2));
			this.thingie.scaleY 	= (0.8 + (Math.cos(this.bounceTimer) * 0.2));

			if(chao.justPressed[chao.KEY_L]){
				chao.logHierarchy(this.rootEntity);
			}

		},

		spawnParticle: function(image, x, y, velX, velY, gravity){
			var newParticle = (new Entity("Particle", x, y)).addComponent(new ComponentParticle(image));
			newParticle.velocity.x 		= velX;
			newParticle.velocity.y 		= velY;
			newParticle.acceleration.y 	= gravity;
			newParticle.rotationVel		= velX * 10;
			newParticle.lifetime		= 2.0;
			newParticle.fadeOutMode		= ComponentParticle.FADE_MODE_LAST_SECOND;
			chao.currentState.add(newParticle.entity);
		},

		playSound: function(button){
			chao.playSound("oh");
			for(var i = 0; i < 23; ++i){
				chao.currentState.spawnParticle("cloudy", 
					chao.screenWidth/2, chao.screenHeight/2, 
					-60 + chao.getRandom(120), 
					-80 - chao.getRandom(40), 
					100);
			}
		},

	};
	
	chao.switchState(StateGame);

</script>

</body>